rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to check if user is member of a couple
    function isCoupleMember(coupleId) {
      let coupleData = get(/databases/$(database)/documents/couples/$(coupleId)).data;
      return coupleData.user1Id == request.auth.uid ||
             coupleData.user2Id == request.auth.uid;
    }

    // Users collection - users can read all, but update rules are relaxed for pairing
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(userId);

      // Allow updates to own document OR when adding partnerId/coupleId (for pairing)
      // IMPORTANT: Subscription fields are protected but can be synced from RevenueCat
      // Protected fields: subscriptionStatus, subscriptionPlatform, subscriptionExpiresAt,
      //                   subscriptionProductId, revenueCatUserId, trialUsed, trialEndsAt
      allow update: if isSignedIn() && (
        (
          isOwner(userId) &&
          // Ensure subscription fields are not being modified by client (except during RevenueCat sync)
          // Allow subscription sync if all changed fields are subscription-related
          (
            !request.resource.data.diff(resource.data).affectedKeys().hasAny([
              'subscriptionStatus',
              'subscriptionPlatform',
              'subscriptionExpiresAt',
              'subscriptionProductId',
              'subscriptionPlatform',
              'lastSyncedAt'
            ]) ||
            // Allow subscription sync from RevenueCat (all fields must be subscription-related)
            request.resource.data.diff(resource.data).affectedKeys().hasOnly([
              'subscriptionStatus',
              'subscriptionPlatform',
              'subscriptionExpiresAt',
              'subscriptionProductId',
              'subscriptionPlatform',
              'lastSyncedAt'
            ])
          )
        ) ||
        // Allow pairing updates (partnerId/coupleId only)
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['partnerId', 'coupleId']) &&
          (
            // Allow if user is setting THEMSELVES as the partner (pairing flow)
            request.resource.data.partnerId == request.auth.uid ||
            // OR if user is the owner (already covered above, but good for clarity)
            isOwner(userId)
          )
        )
      );

      allow delete: if false; // Don't allow deleting users
    }

    // Invite codes collection
    match /inviteCodes/{codeId} {
      // Anyone authenticated can create an invite code
      allow create: if isSignedIn();

      // Anyone can read invite codes (needed to validate codes)
      allow read: if true;

      // Only the creator can update their own codes
      // Or anyone can update when using a code (marking as used)
      allow update: if isSignedIn();

      // Don't allow deleting codes
      allow delete: if false;
    }

    // Couples collection
    match /couples/{coupleId} {
      // Anyone authenticated can create a couple
      allow create: if isSignedIn();

      // Only members of the couple can read
      allow read: if isSignedIn() && (
        resource.data.user1Id == request.auth.uid ||
        resource.data.user2Id == request.auth.uid
      );

      // Only members of the couple can update
      allow update: if isSignedIn() && (
        resource.data.user1Id == request.auth.uid ||
        resource.data.user2Id == request.auth.uid
      );

      // Don't allow deleting couples
      allow delete: if false;
    }

    // Expenses collection
    match /expenses/{expenseId} {
      // Anyone authenticated can create expenses
      // We validate coupleId on the client side
      allow create: if isSignedIn();

      // For reading: check if expense belongs to user's couple
      // Use request.resource for writes, resource for reads
      allow read: if isSignedIn() && (
        // Check if the expense's coupleId matches user's couple membership
        exists(/databases/$(database)/documents/couples/$(resource.data.coupleId)) &&
        (
          get(/databases/$(database)/documents/couples/$(resource.data.coupleId)).data.user1Id == request.auth.uid ||
          get(/databases/$(database)/documents/couples/$(resource.data.coupleId)).data.user2Id == request.auth.uid
        )
      );

      // For listing (queries): allow if user has a couple
      // This is a workaround since we can't access resource.data in queries
      allow list: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId != null;

      // Anyone in the couple can update expenses
      // Allow updating settlement fields (settledAt, settledBySettlementId)
      allow update: if isSignedIn() &&
        exists(/databases/$(database)/documents/couples/$(resource.data.coupleId)) &&
        (
          get(/databases/$(database)/documents/couples/$(resource.data.coupleId)).data.user1Id == request.auth.uid ||
          get(/databases/$(database)/documents/couples/$(resource.data.coupleId)).data.user2Id == request.auth.uid
        ) && (
          // Allow updating any fields if user created the expense
          resource.data.paidBy == request.auth.uid ||
          // Allow only updating settlement fields for all users in couple
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['settledAt', 'settledBySettlementId'])
        );

      // Anyone in the couple can delete expenses
      allow delete: if isSignedIn() &&
        exists(/databases/$(database)/documents/couples/$(resource.data.coupleId)) &&
        (
          get(/databases/$(database)/documents/couples/$(resource.data.coupleId)).data.user1Id == request.auth.uid ||
          get(/databases/$(database)/documents/couples/$(resource.data.coupleId)).data.user2Id == request.auth.uid
        );
    }

    // Settlements collection
    match /settlements/{settlementId} {
      // Users can create settlements ONLY for their own couple
      // Validates: user has couple, settlement is for their couple, user is member of couple
      allow create: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId != null &&
        request.resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId &&
        (request.resource.data.user1Id == request.auth.uid || request.resource.data.user2Id == request.auth.uid) &&
        request.resource.data.amount > 0;

      // For reading individual settlements
      allow read: if isSignedIn() && (
        resource.data.user1Id == request.auth.uid ||
        resource.data.user2Id == request.auth.uid
      );

      // For listing settlements (queries): allow if user has a couple
      allow list: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId != null;

      // Don't allow updating or deleting settlements (immutable audit trail)
      allow update, delete: if false;
    }

    // Categories collection - for budget management
    match /categories/{categoryId} {
      // Users can create categories for their own couple
      allow create: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId != null &&
        request.resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;

      // Users can read categories for their couple
      // Allow reading non-existent documents (for subscriptions) OR documents belonging to user's couple
      allow read: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (!exists(/databases/$(database)/documents/categories/$(categoryId)) ||
         resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId);

      // For listing categories (queries)
      allow list: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId != null;

      // Users can update categories for their couple
      allow update: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;

      // Users can delete categories for their couple (custom categories only, validated in code)
      allow delete: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;
    }

    // Budgets collection - for budget management
    match /budgets/{budgetId} {
      // Users can create budgets for their own couple
      allow create: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId != null &&
        request.resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;

      // Users can read budgets for their couple
      // Allow reading non-existent documents (for subscriptions) OR documents belonging to user's couple
      allow read: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (!exists(/databases/$(database)/documents/budgets/$(budgetId)) ||
         resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId);

      // For listing budgets (queries)
      allow list: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId != null;

      // Users can update budgets for their couple
      allow update: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;

      // Users can delete budgets for their couple
      allow delete: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;
    }

    // Couple Settings collection - for fiscal year and budget preferences
    match /coupleSettings/{coupleId} {
      // Users can create settings for their own couple
      allow create: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId != null &&
        coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;

      // Users can read settings for their couple
      allow read: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (!exists(/databases/$(database)/documents/coupleSettings/$(coupleId)) ||
         coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId);

      // Users can update settings for their couple
      allow update: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;

      // Users can delete settings for their couple
      allow delete: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;
    }

    // Annual Budgets collection - for annual budget management
    match /annualBudgets/{budgetId} {
      // Users can create annual budgets for their own couple
      allow create: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId != null &&
        request.resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;

      // Users can read annual budgets for their couple
      allow read: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (!exists(/databases/$(database)/documents/annualBudgets/$(budgetId)) ||
         resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId);

      // For listing annual budgets (queries)
      allow list: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId != null;

      // Users can update annual budgets for their couple
      allow update: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;

      // Users can delete annual budgets for their couple
      allow delete: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;
    }

    // Savings Targets collection - for savings goal tracking
    match /savingsTargets/{targetId} {
      // Users can create savings targets for their own couple
      allow create: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId != null &&
        request.resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;

      // Users can read savings targets for their couple
      allow read: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (!exists(/databases/$(database)/documents/savingsTargets/$(targetId)) ||
         resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId);

      // For listing savings targets (queries)
      allow list: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId != null;

      // Users can update savings targets for their couple
      allow update: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;

      // Users can delete savings targets for their couple
      allow delete: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;
    }

    // Merchant Aliases collection - for OCR merchant name learning
    match /merchantAliases/{aliasId} {
      // Users can create merchant aliases for their own couple
      allow create: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId != null &&
        request.resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;

      // Users can read merchant aliases for their couple
      allow read: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (!exists(/databases/$(database)/documents/merchantAliases/$(aliasId)) ||
         resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId);

      // For listing merchant aliases (queries)
      allow list: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId != null;

      // Users can update merchant aliases for their couple
      allow update: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;

      // Users can delete merchant aliases for their couple
      allow delete: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;
    }

    // OCR Learning Data collection - for OCR improvement and audit trail
    match /ocrLearningData/{learningId} {
      // Users can create OCR learning data for their own couple (when correcting OCR results)
      allow create: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId != null &&
        request.resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId;

      // Users can read OCR learning data for their couple (read-only access for users)
      allow read: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (!exists(/databases/$(database)/documents/ocrLearningData/$(learningId)) ||
         resource.data.coupleId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId);

      // For listing OCR learning data (queries)
      allow list: if isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId != null;

      // OCR learning data is append-only (no updates allowed to maintain audit trail)
      allow update: if false;

      // Don't allow deleting OCR learning data (maintain audit trail)
      allow delete: if false;
    }
  }
}
